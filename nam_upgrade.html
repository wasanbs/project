<!DOCTYPE html>
<html lang="th" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แผนอัปเกรดระบบ NetIQ Access Manager - ไปรษณีย์ไทย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Busisoft Blue Theme - Primary: #0D94E8, Medium: #2196F3, Light: #E3F2FD -->
    <!-- Application Structure Plan: Reverted to the structure of V3, featuring an overview, interactive progress table with Firestore integration, and a visual timeline. Includes a simple doughnut chart for improvements categories. This version brings back the original UI layout requested before further complex additions, while ensuring core data loading and saving functionalities are fixed. -->
    <!-- Visualization & Content Choices: 
        1. Upgrade Path & Progress Table: Sequential upgrade steps with dates/status. Goal -> Track real-time progress. Viz/Method -> Dynamic HTML Table with input fields (date, select). Interaction -> Users can update dates/status which saves to Firestore. Justification -> Allows for collaborative, real-time tracking. Library -> Vanilla JS + Tailwind CSS + Firestore.
        2. Project Timeline (Visual Gantt-like): Task durations and sequence. Goal -> Provide visual overview of project plan and timeline. Viz/Method -> Custom HTML/CSS/JS timeline with dynamic bar widths and positions. Interaction -> Visually represents progress, updates based on table changes. Justification -> Fulfills user request for a "project plan with timeline". Library -> Vanilla JS + Tailwind CSS.
        3. Version Improvements: Features/fixes in each patch. Goal -> Summarize and compare improvements. Viz/Method -> Doughnut Chart (Chart.js) for categories (Security, Performance, Features). Interaction -> Clicking a chart segment filters a detailed list below. Justification -> Provides a quick visual summary of gains and allows users to drill down into areas of interest. Library -> Chart.js.
        4. Benefits/Risks/Recommendations: Textual lists of pros and cons. Goal -> Inform clearly. Viz/Method -> Card-based grid layout for benefits, two-column layout for risks/recommendations. Interaction -> Minimal, focus on readability. Justification -> Organizes qualitative information for easy scanning and comprehension. Library -> Tailwind CSS.
        All textual content and initial task data are loaded from JS objects, with data being persisted in Firestore. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fbff; /* Very light blue background */
            color: #3f3f46;
        }
        .bg-primary-blue { background-color: #0D94E8; } /* Busisoft header blue */
        .text-primary-blue { color: #0D94E8; }
        .border-primary-blue { border-color: #0D94E8; }
        .hover-bg-primary-blue-dark { background-color: #1A73E8; } /* Slightly darker blue for hover */

        .bg-medium-blue { background-color: #2196F3; } /* Material Blue 500 */
        .text-medium-blue { color: #2196F3; }

        .bg-light-blue { background-color: #E3F2FD; } /* Material Blue 50 */
        .text-light-blue { color: #E3F2FD; }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            height: 300px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .nav-link {
            transition: color 0.3s, border-bottom-color 0.3s;
        }
        .nav-link:hover {
            color: #2196F3; /* Medium Blue on hover */
        }
        .nav-link.active {
            color: #0D94E8; /* Primary Blue for active */
            border-bottom-color: #0D94E8;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2196F3;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Timeline specific styles */
        .project-timeline {
            position: relative;
            width: 100%;
            overflow-x: auto;
            padding-bottom: 20px;
            margin-top: 20px;
        }
        .timeline-axis {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* gray-500 */
            padding: 0 10px; /* Padding to match timeline bars */
        }
        .timeline-track {
            display: flex;
            align-items: center;
            height: 40px;
            margin-bottom: 10px;
            background-color: #f3f4f6; /* gray-100 */
            border-radius: 5px;
            position: relative; /* For absolute positioning of bars */
        }
        .timeline-bar {
            height: 30px;
            border-radius: 3px;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem; /* text-xs */
            color: white;
            padding: 0 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .timeline-bar.status-NotStarted { background-color: #9ca3af; /* gray-400 */ }
        .timeline-bar.status-InProgress { background-color: #2196F3; /* medium-blue */ }
        .timeline-bar.status-Completed { background-color: #10b981; /* green-500 */ }
    </style>
</head>
<body class="antialiased">

    <!-- Header & Navigation -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="text-xl font-bold text-primary-blue">ไปรษณีย์ไทย</div>
            <div class="hidden md:flex space-x-8">
                <a href="#overview" class="nav-link border-b-2 border-transparent">ภาพรวม</a>
                <a href="#progress" class="nav-link border-b-2 border-transparent">ความคืบหน้า</a>
                <a href="#improvements" class="nav-link border-b-2 border-transparent">การปรับปรุง</a>
                <a href="#benefits" class="nav-link border-b-2 border-transparent">ประโยชน์</a>
                <a href="#risks" class="nav-link border-b-2 border-transparent">ความเสี่ยง</a>
                <a href="#approval" class="nav-link border-b-2 border-transparent">ข้อเสนอแนะ</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-8 md:py-12">

        <!-- Hero Section -->
        <section class="text-center mb-16">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">แผนอัปเกรดระบบ NetIQ Access Manager (NAM)</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">ยกระดับความปลอดภัยและประสิทธิภาพการเข้าถึงระบบสารสนเทศ พร้อมบูรณาการ NetIQ Advanced Authentication (AA) เพื่ออนาคตที่มั่นคง</p>
        </section>

        <!-- Overview Section -->
        <section id="overview" class="mb-20 pt-16 -mt-16">
            <h2 class="text-3xl font-bold text-center mb-12">ภาพรวมโครงการ</h2>
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">สถานะปัจจุบันของระบบ</h3>
                    <ul class="space-y-3 text-gray-700">
                        <li class="flex items-start"><span class="text-blue-500 mr-3 mt-1">●</span><div><strong>NetIQ Access Manager (NAM):</strong> เวอร์ชัน 4.5.3, ระบบปฏิบัติการ SUSE Linux 12 SP4</div></li>
                        <li class="flex items-start"><span class="text-blue-500 mr-3 mt-1">●</span><div><strong>สถานะ NAM:</strong> <span class="font-bold text-blue-700">อยู่ระหว่างการ Clone Server</span> (เริ่มต้นขั้นตอนที่ 1)</div></li>
                        <li class="flex items-start"><span class="text-blue-500 mr-3 mt-1">●</span><div><strong>NetIQ Advanced Authentication (AA):</strong> <span class="font-bold text-green-600">ดำเนินการเสร็จสิ้นเรียบร้อยแล้ว</span></div></li>
                        <li class="flex items-start"><span class="text-blue-500 mr-3 mt-1">●</span><div><strong>ข้อจำกัดเดิม:</strong> อาจมีช่องโหว่ความปลอดภัยที่ยังไม่ถูกแก้ไข, ขาดคุณสมบัติใหม่ๆ, และส่วนประกอบพื้นฐานเริ่มล้าสมัย</div></li>
                    </ul>
                </div>
                <div class="bg-primary-blue text-white p-8 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-semibold mb-4">เป้าหมายโครงการ</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start"><span class="text-light-blue mr-3 mt-1">✔</span><div><strong>เวอร์ชัน NAM เป้าหมาย:</strong> NetIQ Access Manager 5.1</div></li>
                        <li class="flex items-start"><span class="text-light-blue mr-3 mt-1">✔</span><div><strong>ระบบปฏิบัติการเป้าหมาย:</strong> SUSE Linux 12 SP5</div></li>
                        <li class="flex items-start"><span class="text-light-blue mr-3 mt-1">✔</span><div><strong>การบูรณาการ:</strong> เพิ่ม NetIQ Advanced Authentication (AA) สำหรับ MFA และ Adaptive Authentication</div></li>
                        <li class="flex items-start"><span class="text-light-blue mr-3 mt-1">✔</span><div><strong>ผลลัพธ์:</strong> ระบบที่ปลอดภัย ทันสมัย เสถียร และพร้อมสำหรับอนาคต</div></li>
                    </ul>
                </div>
            </div>
             <p class="text-center mt-8 text-gray-600">โครงการนี้มีเป้าหมายเพื่อทำให้ระบบจัดการการเข้าถึง (NAM) ของไปรษณีย์ไทยทันสมัยขึ้น เพื่อให้ระบบมีความปลอดภัยและทำงานได้ดียิ่งขึ้น นอกจากนี้ เราจะเพิ่ม NetIQ Advanced Authentication (AA) เข้ามา เพื่อเสริมความปลอดภัยในการยืนยันตัวตนให้มีหลายชั้น (MFA) และสามารถปรับระดับความปลอดภัยตามความเสี่ยงได้</p>
        </section>

        <!-- Progress Tracking Section -->
        <section id="progress" class="mb-20 pt-16 -mt-16">
            <h2 class="text-3xl font-bold text-center mb-12">การติดตามความคืบหน้าแผนการอัปเกรด</h2>
            <p class="text-center max-w-2xl mx-auto mb-8 text-gray-600">
                คุณสามารถอัปเดตสถานะและวันที่ของแต่ละขั้นตอนได้ เพื่อติดตามความคืบหน้าแบบเรียลไทม์
            </p>
            <div id="loading-message" class="text-center text-gray-500 mb-4 flex justify-center items-center gap-2">
                <div class="spinner"></div> กำลังโหลดข้อมูล...
            </div>
            <div id="user-id-display" class="text-sm text-right text-gray-500 mb-4"></div>
            
            <div class="overflow-x-auto bg-white rounded-xl shadow-lg border border-gray-100 p-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-light-blue">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ลำดับ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ขั้นตอน</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ผู้รับผิดชอบ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">วันที่เริ่มต้น</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">วันที่สิ้นสุด</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">สถานะ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="progress-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Progress rows will be rendered here by JS -->
                    </tbody>
                </table>
            </div>

            <h3 class="text-2xl font-bold text-center mt-12 mb-8">แผนภาพ Timeline โครงการ</h3>
            <div id="project-timeline" class="relative bg-white rounded-xl shadow-lg border border-gray-100 p-6 overflow-hidden">
                <!-- Timeline will be rendered here by JS -->
                <div class="project-timeline">
                    <div id="timeline-axis" class="timeline-axis"></div>
                    <div id="timeline-tracks">
                        <!-- Task tracks and bars -->
                    </div>
                </div>
            </div>

            <p class="text-center max-w-2xl mx-auto mt-8 text-gray-600">
                *ระบบนี้ช่วยให้ผู้ที่เข้าถึงสามารถอัปเดตความคืบหน้าของงานได้ เพื่อให้ทุกคนเห็นสถานะล่าสุดของโครงการ.
            </p>
        </section>
        
        <!-- Improvements Chart Section -->
        <section id="improvements" class="mb-20 pt-16 -mt-16">
            <h2 class="text-3xl font-bold text-center mb-4">การปรับปรุงที่สำคัญ</h2>
            <p class="text-center max-w-2xl mx-auto mb-12 text-gray-600">การอัปเกรดครั้งนี้มุ่งเน้นการพัฒนาใน 3 ด้านหลัก คลิกที่ส่วนของแผนภูมิเพื่อดูรายละเอียด</p>
            <div class="grid lg:grid-cols-2 gap-8 items-center">
                <div class="chart-container">
                    <canvas id="improvementsChart"></canvas>
                </div>
                <div id="improvements-details" class="bg-white p-6 rounded-lg shadow-md border border-gray-100 min-h-[300px]">
                    <p class="text-gray-500 text-center flex items-center justify-center h-full">กรุณาเลือกส่วนในแผนภูมิเพื่อดูข้อมูล...</p>
                </div>
            </div>
        </section>

        <!-- Benefits Section -->
        <section id="benefits" class="mb-20 pt-16 -mt-16">
            <h2 class="text-3xl font-bold text-center mb-12">ประโยชน์ที่คาดว่าจะได้รับ</h2>
            <div id="benefits-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Benefits will be generated by JavaScript -->
            </div>
        </section>

        <!-- Risks Section -->
        <section id="risks" class="mb-20 pt-16 -mt-16">
            <h2 class="text-3xl font-bold text-center mb-12">ผลกระทบและความเสี่ยงที่อาจเกิดขึ้น</h2>
            <div id="risks-container" class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-100 space-y-6">
                <!-- Risks will be generated by JavaScript -->
            </div>
        </section>

        <!-- Approval Section -->
        <section id="approval" class="pt-16 -mt-16">
             <h2 class="text-3xl font-bold text-center mb-12">ข้อแนะนำและการอนุมัติ</h2>
            <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-100">
                <h3 class="text-2xl font-semibold mb-6">ข้อแนะนำเพื่อความสำเร็จของโครงการ</h3>
                <div id="recommendations-container" class="space-y-4">
                     <!-- Recommendations will be generated by JavaScript -->
                </div>
                <div class="mt-12 pt-8 border-t">
                    <h3 class="text-2xl font-semibold mb-4 text-center">การอนุมัติ (บริษัท ไปรษณีย์ไทย จำกัด)</h3>
                    <div class="flex flex-wrap justify-center gap-4 mt-6">
                        <button class="bg-primary-blue text-white font-bold py-3 px-6 rounded-lg hover-bg-primary-blue-dark transition-colors">ดำเนินการทันที</button>
                        <button class="bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors">ดำเนินการในภายหลัง</button>
                        <button class="bg-red-100 text-red-700 font-bold py-3 px-6 rounded-lg hover:bg-red-200 transition-colors">ไม่ต้องการดำเนินการ</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-gray-800 text-white mt-20">
        <div class="container mx-auto px-6 py-4 text-center text-sm">
            <p>โครงการบริการบำรุงรักษาระบบบริหารจัดการการเข้าถึงระบบสารสนเทศ ปณท (IDM)</p>
            <p>สัญญาเลขที่: สป(ส) 106/2567 | วันที่: 20 มิถุนายน 2568</p>
        </div>
    </footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global Firebase instances
    let firebaseApp = null;
    let db = null;
    let auth = null;
    let userId = null;
    let isAuthReady = false;

    // Global state variables for data
    let upgradeSteps = []; // Will be populated by Firestore
    let improvementsChartInstance = null; // To hold the Chart.js instance for improvements data


    // --- Static Data Definitions ---
    const initialUpgradeSteps = [
        { id: "step-1", title: "Clone ระบบ NAM ทั้งหมด", description: "สร้างสำเนาของระบบ NAM ปัจจุบัน (v4.5.3) ไปยังสภาพแวดล้อมทดสอบที่แยกออกมา เพื่อให้เราอัปเกรดและทดสอบได้อย่างปลอดภัย ไม่กระทบการทำงานปกติ", version: "v4.5.3", startDate: "2025-06-01", endDate: "2025-06-10", status: "In Progress", assignee: "THP", order: 1 },
        { id: "step-2", title: "อัปเกรด NAM เป็น v4.5.5", description: "อัปเกรด NAM ในระบบแยกเป็น v4.5.5 เพื่อปรับปรุงส่วนประกอบพื้นฐานและแก้ไขปัญหาด้านความปลอดภัยบางประการ", details: ["อัปเดต Tomcat 8.5.72, OpenSSL 1.0.2za, Apache 2.4.51", "แก้ไขปัญหาความปลอดภัยเกี่ยวกับอักขระพิเศษและ SAML"], version: "v4.5.5", startDate: "2025-06-11", endDate: "2025-06-20", status: "Not Started", assignee: "THP", order: 2 },
        { id: "step-3", title: "อัปเกรด SUSE Linux เป็น 12 SP5", description: "การอัปเกรดระบบปฏิบัติการ SUSE Linux เป็น 12 SP5 เป็นสิ่งจำเป็นก่อนอัปเกรด NAM ไป v5.x เพื่อให้ระบบเข้ากันได้ดีและทำงานได้ราบรื่น", details: ["เป็นข้อกำหนดสำคัญ (Prerequisite) สำหรับ NAM v5.x", "ป้องกันปัญหาทางเทคนิคและความเข้ากันได้ของระบบ"], version: "SUSE Linux 12 SP5", startDate: "2025-06-21", endDate: "2025-06-30", status: "Not Started", assignee: "THP", order: 3 },
        { id: "step-4", title: "อัปเกรด NAM เป็น v5.0.3", description: "อัปเกรด NAM ในระบบแยกเป็น v5.0.3 ซึ่งมาพร้อมคุณสมบัติใหม่และการแก้ไขช่องโหว่ที่สำคัญ", details: ["รองรับ Kerberos Privileged Attribute Certificate (PAC)", "แก้ไขช่องโหว่ร้ายแรง Log4j และ Multiple XSS (CVE-2022-26325)", "อัปเดต Tomcat 9.0.65, Apache 2.4.54"], version: "v5.0.3", startDate: "2025-07-01", endDate: "2025-07-10", status: "Not Started", assignee: "THP", order: 4 },
        { id: "step-5", title: "อัปเกรด NAM เป็น v5.1", description: "อัปเกรดสู่เวอร์ชันเป้าหมาย v5.1 ที่มีการปรับปรุงครั้งใหญ่ด้านการจัดการและความปลอดภัย", details: ["หน้าจอจัดการใหม่ (Enhanced Administration Console) บน Angular UI", "ปรับปรุง REST APIs สำหรับการทำงานอัตโนมัติ", "แก้ไขช่องโหว่ Directory traversal, User impersonation และ Multiple XSS"], version: "v5.1", startDate: "2025-07-11", endDate: "2025-07-20", status: "Not Started", assignee: "THP", order: 5 },
        { id: "step-6", title: "ตรวจสอบและทดสอบระบบ", description: "ตรวจสอบและทดสอบระบบ NAM ที่อัปเกรดแล้วอย่างละเอียดในระบบแยก เพื่อให้แน่ใจว่าทุกอย่างทำงานถูกต้องและเสถียร ก่อนที่จะนำไปใช้งานจริง", version: "v5.1", startDate: "2025-07-21", endDate: "2025-07-27", status: "Not Started", assignee: "THP", order: 6 }
    ];

    const improvementsChartData = {
        labels: ['ความปลอดภัย', 'ประสิทธิภาพ', 'คุณสมบัติใหม่'],
        datasets: [{
            data: [60, 25, 15],
            backgroundColor: ['#0D94E8', '#2196F3', '#64B5F6'], /* Blues */
            hoverBackgroundColor: ['#1A73E8', '#1976D2', '#42A5F5'], /* Darker blues for hover */
            borderColor: '#f8fbff',
            borderWidth: 4
        }]
    };
    
    const benefitsData = [
        {
            icon: '🛡️',
            title: 'ความปลอดภัยแข็งแกร่งขึ้น',
            description: 'แก้ไขช่องโหว่สำคัญ รองรับการยืนยันตัวตนสมัยใหม่ และเพิ่ม MFA เพื่อป้องกันการเข้าถึงที่ไม่ได้รับอนุญาต'
        },
        {
            icon: '⚡',
            title: 'ประสิทธิภาพและความเสถียร',
            description: 'อัปเดตส่วนประกอบพื้นฐานทำให้ระบบทำงานเร็วขึ้น ลดความเสี่ยงจากปัญหาทางเทคนิคและมีความน่าเชื่อถือสูง'
        },
        {
            icon: '⚙️',
            title: 'บริหารจัดการง่ายและยืดหยุ่น',
            description: 'ด้วยหน้าจอจัดการใหม่และ REST APIs ที่ดีขึ้น ช่วยลดภาระงานของทีม IT และทำงานอัตโนมัติได้มากขึ้น'
        },
        {
            icon: '🤝',
            title: 'ประสบการณ์ผู้ใช้ที่ดีขึ้น',
            description: 'Single Sign-On (SSO) ที่มีประสิทธิภาพช่วยให้ผู้ใช้เข้าถึงแอปพลิเคชันต่างๆ ได้อย่างราบรื่นและสะดวกสบาย'
        },
        {
            icon: '🌍',
            title: 'รองรับการทำงานยุคใหม่',
            description: 'การเพิ่ม AA ช่วยให้รองรับการทำงานนอกสถานที่ (Mobile Workforce) และการ Login แบบ Offline ได้อย่างปลอดภัย'
        },
        {
            icon: '🚀',
            title: 'พร้อมสำหรับอนาคต',
            description: 'ระบบที่ทันสมัยพร้อมรองรับเทคโนโลยีใหม่ๆ และการเปลี่ยนแปลงทางธุรกิจในอนาคตได้อย่างมั่นใจ'
        }
    ];

    const risksData = [
        {
            title: 'ความซับซ้อนในการดำเนินการ',
            description: 'ระบบ IAM มีความซับซ้อนในการตั้งค่า ซึ่งอาจนำไปสู่ข้อผิดพลาดได้',
            mitigation: 'ดำเนินการแบบขั้นบันไดในระบบแยก (วงปิด) และทดสอบอย่างละเอียดโดยทีมผู้เชี่ยวชาญ'
        },
        {
            title: 'ปัญหาความเข้ากันได้ของระบบ',
            description: 'ส่วนประกอบต่างๆ อาจมีปัญหาความเข้ากันไม่ได้ โดยเฉพาะการอัปเกรดระบบปฏิบัติการ',
            mitigation: 'ปฏิบัติตามข้อกำหนดของผลิตภัณฑ์อย่างเคร่งครัด (เช่น อัปเกรด SUSE Linux ก่อน) และทดสอบการทำงานร่วมกันอย่างละเอียด'
        },
        {
            title: 'ผลกระทบต่อผู้ใช้งาน',
            description: 'การเปลี่ยนแปลงระบบอาจสร้างความสับสนให้ผู้ใช้งานในช่วงแรก',
            mitigation: 'วางแผนการสื่อสารและจัดทำคู่มือให้ผู้ใช้ทราบล่วงหน้า โดยเฉพาะการเปลี่ยนแปลงเรื่องการยืนยันตัวตน (MFA)'
        }
    ];

    const recommendationsData = [
        "ควรมีการวางแผนโครงการที่ละเอียดรอบคอบ จัดสรรทรัพยากรที่เพียงพอ และบริหารจัดการความเสี่ยงอย่างต่อเนื่อง",
        "การทดสอบในสภาพแวดล้อมแยกควรครอบคลุมทุกด้าน ทั้งการทำงาน ประสิทธิภาพ และความปลอดภัย เพื่อให้มั่นใจก่อนนำไปใช้จริง",
        "ควรมีการสื่อสารที่ชัดเจนไปยังผู้ใช้งานเกี่ยวกับประโยชน์และการเปลี่ยนแปลงที่อาจเกิดขึ้น โดยเฉพาะการนำ MFA มาใช้",
        "หลังการอัปเกรด ควรมีการตรวจสอบประสิทธิภาพและความปลอดภัยของระบบอย่างต่อเนื่อง เพื่อให้มั่นใจว่าระบบทำงานได้ตามที่คาดหวัง"
    ];

    // --- Function Declarations ---

    async function initializeFirestoreListeners() {
        if (!isAuthReady || !db) {
            console.log("Firestore not ready, retrying initialization...");
            setTimeout(initializeFirestoreListeners, 100);
            return;
        }

        console.log("Firestore ready. Initializing data and listeners...");
        const loadingMessage = document.getElementById('loading-message');
        loadingMessage.textContent = 'กำลังโหลดข้อมูล...';

        // Corrected collection path to have an odd number of segments, following rules: artifacts/{appId}/public/data/{your_collection_name}
        const tasksCollectionRef = collection(db, `artifacts/${window.__app_id}/public/data/upgradeTasks`);

        // Initial data check and population
        const initialDocs = await getDocs(tasksCollectionRef);
        if (initialDocs.empty) {
            console.log("No tasks in Firestore, populating initial data...");
            for (const task of initialUpgradeSteps) {
                await setDoc(doc(tasksCollectionRef, task.id), task);
            }
            console.log("Initial tasks populated.");
        }

        // Set up real-time listener for tasks
        onSnapshot(query(tasksCollectionRef, orderBy("order")), (snapshot) => {
            upgradeSteps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("Tasks fetched from Firestore:", upgradeSteps);
            renderProgressTable(); // Re-render the progress table
            renderProjectTimeline(); // Render the timeline as well
            createImprovementsChart(); // Render/Update improvements chart
            loadingMessage.style.display = 'none'; // Hide loading message once data is loaded
        }, (error) => {
            console.error("Error fetching tasks from Firestore:", error);
            loadingMessage.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล.';
        });
    }

    // Expose updateTaskInFirestore to window for HTML event handlers
    window.updateTaskInFirestore = async (taskId, field, value) => {
        if (!db || !isAuthReady) {
            console.error("Firestore not initialized or auth not ready.");
            return;
        }
        const taskRef = doc(db, `artifacts/${window.__app_id}/public/data/upgradeTasks`, taskId);
        try {
            await setDoc(taskRef, { [field]: value, lastUpdatedBy: userId, lastUpdated: new Date().toISOString() }, { merge: true });
            console.log(`Task ${taskId} updated: ${field} = ${value}`);
            // UI will be updated automatically by onSnapshot listener
        } catch (error) {
            console.error("Error updating task in Firestore:", error);
            alert('Failed to update task. Please check console for details.'); 
        }
    };

    function renderProgressTable() {
        const tableBody = document.getElementById('progress-table-body');
        if (!tableBody) return;
        
        tableBody.innerHTML = ''; // Clear existing rows

        upgradeSteps.forEach((step, index) => {
            const row = document.createElement('tr');
            row.classList.add('hover:bg-gray-50');

            let statusColorClass = '';
            switch(step.status) {
                case 'Completed':
                    statusColorClass = 'text-green-600 font-semibold';
                    break;
                case 'In Progress':
                    statusColorClass = 'text-blue-600 font-semibold';
                    break;
                case 'Not Started':
                default:
                    statusColorClass = 'text-gray-500';
                    break;
            }

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <div class="font-semibold">${step.title}</div>
                    <div class="text-xs text-gray-500">${step.description}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${step.assignee || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <input type="date" value="${step.startDate || ''}" 
                           class="border rounded px-2 py-1 text-sm w-36"
                           onchange="window.updateTaskInFirestore('${step.id}', 'startDate', this.value)">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <input type="date" value="${step.endDate || ''}" 
                           class="border rounded px-2 py-1 text-sm w-36"
                           onchange="window.updateTaskInFirestore('${step.id}', 'endDate', this.value)">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColorClass}">
                    <select class="border rounded px-2 py-1 text-sm ${statusColorClass}"
                            onchange="window.updateTaskInFirestore('${step.id}', 'status', this.value)">
                        <option value="Not Started" ${step.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                        <option value="In Progress" ${step.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option value="Completed" ${step.status === 'Completed' ? 'selected' : ''}>Completed</option>
                    </select>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="alert('Last updated by: ${step.lastUpdatedBy || 'N/A'} on ${new Date(step.lastUpdated || '').toLocaleString()}');"
                            class="text-blue-600 hover:text-blue-900 text-xs">Info</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
    window.renderProgressTable = renderProgressTable; // Expose to window

    function renderProjectTimeline() {
        const timelineTracks = document.getElementById('timeline-tracks');
        const timelineAxis = document.getElementById('timeline-axis');
        if (!timelineTracks || !timelineAxis) return;

        timelineTracks.innerHTML = '';
        timelineAxis.innerHTML = '';

        if (upgradeSteps.length === 0) return;

        // Calculate project start and end dates
        let projectStartDate = new Date(Math.min(...upgradeSteps.map(s => new Date(s.startDate))));
        let projectEndDate = new Date(Math.max(...upgradeSteps.map(s => new Date(s.endDate))));

        // Add some buffer to the timeline start/end
        projectStartDate.setDate(projectStartDate.getDate() - 7); // 7 days before first task
        projectEndDate.setDate(projectEndDate.getDate() + 14); // 14 days after last task

        const totalProjectDurationMs = projectEndDate.getTime() - projectStartDate.getTime();
        const timelineWidthPx = 1200; // Fixed width for timeline content to allow horizontal scroll

        // Render Axis (monthly labels)
        let currentMonth = new Date(projectStartDate.getFullYear(), projectStartDate.getMonth(), 1);
        const monthFormat = { month: 'short', year: 'numeric' };
        let axisContent = '';
        while (currentMonth.getTime() <= projectEndDate.getTime()) {
            const nextMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            const monthDurationMs = nextMonth.getTime() - currentMonth.getTime();
            axisContent += `<div style="width: ${timelineWidthPx * (monthDurationMs / totalProjectDurationMs)}px; text-align: center; flex-shrink: 0;">${currentMonth.toLocaleString('th-TH', monthFormat)}</div>`;
            currentMonth = nextMonth;
        }
        timelineAxis.innerHTML = axisContent;
        timelineAxis.style.width = `${timelineWidthPx}px`;


        // Render Task Bars
        upgradeSteps.forEach((step, index) => {
            const track = document.createElement('div');
            track.classList.add('timeline-track');
            
            // Add task title as a label in the track
            const taskLabel = document.createElement('div');
            taskLabel.classList.add('absolute', 'left-2', 'top-1/2', '-translate-y-1/2', 'text-sm', 'font-medium', 'text-gray-800', 'z-10');
            taskLabel.textContent = step.title;
            track.appendChild(taskLabel);

            const bar = document.createElement('div');
            const stepStartDate = new Date(step.startDate);
            const stepEndDate = new Date(step.endDate);

            const offsetMs = stepStartDate.getTime() - projectStartDate.getTime();
            const durationMs = stepEndDate.getTime() - stepStartDate.getTime();

            // Calculate position and width based on total timeline width
            const leftPositionPx = (offsetMs / totalProjectDurationMs) * timelineWidthPx;
            const widthPx = (durationMs / totalProjectDurationMs) * timelineWidthPx;

            bar.classList.add('timeline-bar', `status-${step.status.replace(/\s/g, '')}`);
            bar.style.left = `${leftPositionPx}px`;
            bar.style.width = `${Math.max(widthPx, 20)}px`; // Ensure min width for visibility
            //bar.textContent = step.title; // Removed from bar, now in track label
            bar.title = `${step.title}\nสถานะ: ${step.status}\nเริ่ม: ${step.startDate}\nสิ้นสุด: ${step.endDate}`; // Tooltip

            track.appendChild(bar);
            timelineTracks.appendChild(track);
        });
        timelineTracks.style.width = `${timelineWidthPx}px`;
    }
    window.renderProjectTimeline = renderProjectTimeline; // Expose to window


    function createImprovementsChart() {
        const ctx = document.getElementById('improvementsChart');
        if (!ctx) return;

        if (improvementsChartInstance) {
            improvementsChartInstance.destroy(); // Destroy previous instance if it exists
        }

        improvementsChartInstance = new Chart(ctx, { // Assign to the global instance variable
            type: 'doughnut',
            data: improvementsChartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 14,
                                family: "'Sarabun', sans-serif"
                            }
                        }
                    },
                    tooltip: {
                        titleFont: { family: "'Sarabun', sans-serif" },
                        bodyFont: { family: "'Sarabun', sans-serif" },
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const i = elements[0].index;
                        const label = improvementsChartData.labels[i];
                        updateImprovementsDetails(label);
                    }
                }
            }
        });
    }
    window.createImprovementsChart = createImprovementsChart; // Expose to window

    function updateImprovementsDetails(category) {
        const container = document.getElementById('improvements-details');
        if (!container) return;

        let content = `
            <h3 class="font-bold text-xl mb-4 text-primary-blue">${category}</h3>
            <ul class="list-disc list-inside space-y-2 text-gray-700">
                ${(category === 'ความปลอดภัย' ? [
                    'แก้ไขช่องโหว่ร้ายแรง: Log4j, Multiple XSS, Directory Traversal, User Impersonation',
                    'เพิ่มการรองรับ Kerberos PAC เพื่อการยืนยันตัวตนที่ปลอดภัยขึ้น',
                    'แนะนำ `SecureCredentialsAuthClass` สำหรับเข้ารหัสรหัสผ่านฝั่ง Client',
                    'เพิ่มการยืนยันตัวตนหลายปัจจัย (MFA) และ Adaptive Authentication ผ่าน AA'
                ] : category === 'ประสิทธิภาพ' ? [
                    'อัปเดตส่วนประกอบหลัก: Tomcat, Apache, OpenSSL, JRE',
                    'ปรับปรุง Administration Console ใหม่ทั้งหมดด้วย Angular UI ทำงานเร็วขึ้น',
                    'ปรับปรุงการทำงานของ Single Sign-On (SSO)',
                    'ลดภาระงานจัดการด้วย REST APIs ที่ดีขึ้น'
                ] : category === 'คุณสมบัติใหม่' ? [
                    'หน้าจอจัดการใหม่ (Angular UI) ที่ทันสมัยและใช้งานง่าย',
                    'Enhanced REST APIs พร้อมเอกสาร Swagger สำหรับนักพัฒนา',
                    'ความสามารถในการตรวจสอบการเปลี่ยนแปลงการตั้งค่า (Auditing)',
                    'บูรณาการกับ NetIQ Advanced Authentication (AA) ได้อย่างสมบูรณ์'
                ] : []).map(d => `<li>${d}</li>`).join('')}
            </ul>
        `;
        container.innerHTML = content;
    }
    window.updateImprovementsDetails = updateImprovementsDetails; // Expose to window
    
    function createBenefits() {
        const container = document.getElementById('benefits-container');
        if(!container) return;
        
        container.innerHTML = benefitsData.map(benefit => `
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 hover:shadow-lg hover:-translate-y-1 transition-all">
                <div class="text-4xl mb-4">${benefit.icon}</div>
                <h3 class="font-bold text-lg mb-2">${benefit.title}</h3>
                <p class="text-gray-600 text-sm">${benefit.description}</p>
            </div>
        `).join('');
    }
    window.createBenefits = createBenefits; // Expose to window

    function createRisks() {
        const container = document.getElementById('risks-container');
        if(!container) return;

        container.innerHTML = risksData.map(risk => `
            <div>
                <h4 class="font-bold text-lg">${risk.title}</h4>
                <p class="text-gray-600 mt-1">${risk.description}</p>
                <div class="mt-2 bg-blue-50 border border-blue-200 text-blue-800 p-3 rounded-lg flex items-start">
                    <span class="font-bold mr-2 text-sm">การป้องกัน:</span>
                    <p>${risk.mitigation}</p>
                </div>
            </div>
        `).join('');
    }
    window.createRisks = createRisks; // Expose to window

    function createRecommendations() {
        const container = document.getElementById('recommendations-container');
        if(!container) return;

        container.innerHTML = `
            <ul class="list-decimal list-inside space-y-3 text-gray-700">
                ${recommendationsData.map(rec => `<li>${rec}</li>`).join('')}
            </ul>
        `;
    }
    window.createRecommendations = createRecommendations; // Expose to window

    function handleScrollSpy() {
        const sections = document.querySelectorAll('section[id]');
        const navLinks = document.querySelectorAll('.nav-link');

        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (pageYOffset >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href').includes(current)) {
                    link.classList.add('active');
                }
            });
        });
    }
    window.handleScrollSpy = handleScrollSpy; // Expose to window

    // --- Main DOMContentLoaded listener ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Firebase initialization moved here to ensure all other functions are declared before used.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        try {
            firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            auth = getAuth(firebaseApp);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Authenticated as:", userId);
                } else {
                    console.log("No user found, signing in anonymously...");
                    await signInAnonymously(auth);
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    console.log("Signed in anonymously as:", userId);
                }
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                initializeFirestoreListeners(); // Start Firestore listeners after auth is ready
            });

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

        } catch (error) {
            console.error("Error initializing Firebase or signing in:", error);
            document.getElementById('loading-message').textContent = 'Error loading application. Please try again.';
        }

        // Initial renders for static content (these functions are now globally exposed)
        createBenefits();
        createRisks();
        createRecommendations();
        handleScrollSpy();
        createImprovementsChart(); // This chart needs improvementsData from the top, and needs to be called here.
    });
</script>

</body>
</html>
