<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NetIQ Upgrade Timeline</title>
  <script type="module">
    function renderProjectTimeline() {
      const timelineTracks = document.getElementById('timeline-tracks');
      const timelineAxisContainer = document.getElementById('timeline-axis-container');
      if (!timelineTracks || !timelineAxisContainer) return;

      timelineTracks.innerHTML = '';
      timelineAxisContainer.innerHTML = '';

      const steps = window.upgradeSteps.filter(s => s.startDate && s.endDate);
      if (steps.length === 0) {
        timelineTracks.innerHTML = '<div class="text-center py-4 text-gray-500">ไม่มีข้อมูล Timeline</div>';
        return;
      }

      const parseDate = str => new Date(str);
      const minDate = new Date(Math.min(...steps.map(s => parseDate(s.startDate))));
      const maxDate = new Date(Math.max(...steps.map(s => parseDate(s.endDate))));
      maxDate.setDate(maxDate.getDate() + 30);

      const pixelsPerDay = 5;
      const totalDays = (maxDate - minDate) / (1000 * 60 * 60 * 24);
      const chartWidth = Math.max(800, totalDays * pixelsPerDay);

      let currentMonth = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
      const axisHTML = [];
      while (currentMonth <= maxDate) {
        const next = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
        const daysInMonth = (Math.min(next, maxDate) - Math.max(currentMonth, minDate)) / (1000 * 60 * 60 * 24);
        const width = daysInMonth * pixelsPerDay;
        axisHTML.push(`<div class="timeline-axis-month" style="width: ${width}px;">${currentMonth.toLocaleDateString('th-TH', { month: 'short', year: 'numeric' })}</div>`);
        currentMonth = next;
      }
      timelineAxisContainer.innerHTML = axisHTML.join('');
      timelineAxisContainer.style.width = `${chartWidth}px`;

      steps.sort((a, b) => a.order - b.order).forEach(step => {
        const track = document.createElement('div');
        track.className = 'timeline-track';

        const label = document.createElement('div');
        label.className = 'timeline-label-area';
        label.textContent = step.title;

        const chartArea = document.createElement('div');
        chartArea.className = 'timeline-chart-area';
        chartArea.style.width = `${chartWidth}px`;

        const bar = document.createElement('div');
        const start = parseDate(step.startDate);
        const end = parseDate(step.endDate);
        const offset = (start - minDate) / (1000 * 60 * 60 * 24);
        const duration = (end - start) / (1000 * 60 * 60 * 24);

        bar.className = `timeline-bar status-${step.status.replace(/\s/g, '')}`;
        bar.style.left = `${offset * pixelsPerDay}px`;
        bar.style.width = `${Math.max(duration * pixelsPerDay, 20)}px`;
        bar.title = `${step.title}\nสถานะ: ${step.status}\nเริ่ม: ${step.startDate}\nสิ้นสุด: ${step.endDate}`;

        chartArea.appendChild(bar);
        track.appendChild(label);
        track.appendChild(chartArea);
        timelineTracks.appendChild(track);
      });

      timelineTracks.style.width = `calc(450px + ${chartWidth}px)`;
    }
    window.renderProjectTimeline = renderProjectTimeline;
  </script>
</head>
<body>
  <div id="project-timeline">
    <div class="project-timeline">
      <div id="timeline-axis-container" class="timeline-axis-container"></div>
      <div id="timeline-tracks"></div>
    </div>
  </div>
</body>
</html>
